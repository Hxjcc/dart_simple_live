name: Windows Build & Release

# è®¾ç½®ä¸ºæ‰‹åŠ¨è§¦å‘ï¼Œå¹¶å¢åŠ ä¸€ä¸ª "tag" è¾“å…¥æ¡†
on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'è¯·è¾“å…¥è¦å‘å¸ƒçš„ Git Tag (ä¾‹å¦‚: v1.0.0)'
        required: true

jobs:
  # æ‰“åŒ…å¹¶å‘å¸ƒ Windows ç‰ˆæœ¬
  build-and-release-windows:
    runs-on: windows-latest
    permissions:
      # éœ€è¦å†™å…¥æƒé™æ¥åˆ›å»º Release
      contents: write
    steps:
      # 1. ç­¾å‡ºä»£ç 
      # ä¼šç­¾å‡ºä½ åœ¨æ‰‹åŠ¨è¿è¡Œæ—¶é€‰æ‹©çš„åˆ†æ”¯
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. è®¾ç½® Flutter ç¯å¢ƒ
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.22.x"
          cache: true
      
      # 3. å¯ç”¨ Windowsæ¡Œé¢åº”ç”¨æ”¯æŒ
      - name: Enable Flutter Desktop for Windows
        run: flutter config --enable-windows-desktop
      
      # 4. è·å–é¡¹ç›®ä¾èµ–
      - name: Restore Packages
        # æŒ‡å®šåœ¨ simple_live_app ç›®å½•ä¸‹è¿è¡Œ
        working-directory: simple_live_app
        run: flutter pub get

      # 5. å®‰è£… flutter_distributor ç”¨äºæ‰“åŒ…
      - name: Install flutter_distributor
        run: dart pub global activate flutter_distributor

      # 6. æ‰“åŒ… Windows åº”ç”¨
      - name: Build Windows App
        working-directory: simple_live_app
        run: flutter_distributor package --platform windows --targets msix,zip --skip-clean

      # 7. (å¯é€‰) å°†æ„å»ºäº§ç‰©ä¸Šä¼ åˆ° Artifactsï¼Œæ–¹ä¾¿è°ƒè¯•å’Œä¸‹è½½
      - name: Upload Windows APP to Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: |
            simple_live_app/build/dist/*/*.msix
            simple_live_app/build/dist/*/*.zip

      # 8. è¯»å–åº”ç”¨ç‰ˆæœ¬ä¿¡æ¯
      - name: Read version info
        id: version
        uses: juliangruber/read-file-action@v1
        with:
          # ã€é‡è¦ã€‘ä¿®æ­£äº† app_version.json æ–‡ä»¶çš„è·¯å¾„
          path: simple_live_app/assets/app_version.json

      # 9. åˆ›å»ºå¹¶å‘å¸ƒåˆ° GitHub Release
      - name: Create and Upload Release
        uses: softprops/action-gh-release@v1
        with:
          # ä½¿ç”¨æ‰‹åŠ¨è¿è¡Œæ—¶è¾“å…¥çš„ tag ä½œä¸º Release çš„ Git Tag
          tag_name: ${{ github.event.inputs.tag }}
          # Release çš„æ ‡é¢˜ï¼Œä¾‹å¦‚ "Release v1.0.0"
          name: "Release ${{ github.event.inputs.tag }}"
          # Release çš„æè¿°å†…å®¹ï¼Œä» json æ–‡ä»¶ä¸­è¯»å–
          body: "${{ fromJson(steps.version.outputs.content).version_desc }}"
          # æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬ï¼Œä» json æ–‡ä»¶ä¸­è¯»å–
          prerelease: ${{ fromJson(steps.version.outputs.content).prerelease }}
          # ä½¿ç”¨ GitHub è‡ªåŠ¨æä¾›çš„ Token
          token: ${{ secrets.GITHUB_TOKEN }}
          # éœ€è¦ä¸Šä¼ çš„æ–‡ä»¶åˆ—è¡¨
          files: |
            simple_live_app/build/dist/*/*.msix
            simple_live_app/build/dist/*/*.zip

      # 10. å®Œæˆ
      - name: Job Finished
        run: echo "ğŸªŸ Windows build and release job's status is ${{ job.status }}."
